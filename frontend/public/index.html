<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AI Assistants Suite</title>
    <meta name="description" content="AI-powered assistants for various tasks and conversations">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="bingbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <link rel="canonical" href="https://ai.datera.is/">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F9FA;
        }
        
        /* Force proper layout from start - more aggressive approach */
        .main-content {
            height: 100vh !important;
            display: flex !important;
            flex-direction: column !important;
            position: relative !important;
        }
        
        .main-header {
            flex-shrink: 0 !important;
            position: relative !important;
        }
        
        .chat-output {
            flex: 1 !important;
            overflow-y: auto !important;
            min-height: 0 !important;
            position: relative !important;
        }
        
        .input-area {
            flex-shrink: 0 !important;
            position: relative !important;
            margin-top: auto !important;
        }
        
        /* Ensure input stays at bottom */
        .input-area {
            position: sticky !important;
            bottom: 0 !important;
            background: white !important;
            z-index: 10 !important;
        }
        /* User's chat bubble style */
        .chat-bubble-user {
            background-color: #F1F1F1;
            color: #1F2937;
        }
        /* Bot's chat bubble style - using user's preferred color */
        .chat-bubble-bot {
            background-color: #F3E1C2;
            color: #1F2937;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c4c4c4;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        .bot-pill:hover .new-chat-icon {
            opacity: 1;
        }
        
        .conversation-item:hover .conversation-menu-btn {
            opacity: 1;
        }
        
        /* Custom colors from mockup */
        .sidebar-bg { background-color: #F1F1F1; }
        
        .bot-hover-bg:hover { 
            background-color: #00FFC7; 
        }

        /* Active bot styling */
        .bot-active {
            background-color: #00FFC7 !important;
        }
        
        .bot-active .new-chat-icon {
            opacity: 0.2;
        }
        
        .bot-active:hover {
            background-color: #00E6B3 !important;
        }
        
        .bot-active:hover .new-chat-icon {
            opacity: 1;
        }

        /* Mode help tooltip styling */
        #mode-help-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #374151;
        }

        .conversation-hover-bg:hover { background-color: #E9E9E9; }

        /* Prevent selections during interaction */
        .prevent-select {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Disabled bot styling */
        .bot-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .coming-soon-badge {
            background-color: #F59E0B;
            color: white;
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 8px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .bot-pill span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Typing indicator */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #9CA3AF;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="h-screen flex text-gray-800">

    <!-- Sidebar -->
    <aside class="w-80 bg-white border-r border-gray-200 flex flex-col shrink-0">
        <!-- Header & Bot Selection -->
        <div class="p-4 sidebar-bg flex-shrink-0">
             <div class="flex items-center h-16 mb-4">
                 <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="94.25 84.81 200.55 185.11" class="mr-2">
                  <g> <path fill="black" d="M204.63,93.39H132.08c-20.1,0-32.56,16.2-37.83,35.92a.54.54,0,0,0,.78.6c3.75-2.11,16.94-8.58,37.71-8.58H249.63S235.23,93.39,204.63,93.39Z"/>
                    <path fill="black" d="M294.8,177.68l-29.26-33.33a12,12,0,0,0-9-4.08H132.08c-20.1,0-32.56,16.2-37.83,35.91a.54.54,0,0,0,.78.6c3.72-2.12,16.64-8.57,35.76-8.57H248a5.23,5.23,0,0,1,3.92,1.76l6.82,7.71-6.82,7.7a5.23,5.23,0,0,1-3.92,1.76H132.08c-20.1,0-32.56,16.2-37.83,35.91a.54.54,0,0,0,.79.6c3.72-2.11,16.64-8.57,35.76-8.57H256.53a12,12,0,0,0,9-4.09Z"/>
                    <path fill="black" d="M132.08,234c-20.1,0-32.56,16.21-37.83,35.92a.54.54,0,0,0,.78.6C98.78,268.43,112,262,132.74,262h71.89c30.6,0,45-27.94,45-27.94Z"/>
                  </g>
                </svg>
                <h1 class="text-xl font-bold">AI Assistants Suite</h1>
            </div>
            <div id="bot-list" class="space-y-1">
                <!-- Bot pills will be populated by JS -->
            </div>
        </div>

        <!-- Folders & Conversations -->
        <div class="flex-1 p-4 overflow-y-auto bg-white">
            <button id="new-folder-button" class="flex items-center w-full text-left text-sm p-2 rounded-md hover:bg-gray-100 text-gray-600 mb-4">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                New folder
            </button>
            <div id="folder-list" class="space-y-1 mb-4">
                <!-- Folders will be populated by JS -->
            </div>
            
            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Conversations</h3>
            <div id="conversation-list" class="space-y-1">
                <!-- Conversations will be populated by JS -->
            </div>
        </div>

    </aside>

    <!-- Main Content -->
    <main class="main-content flex-1 bg-white h-full">
        <!-- Main Header (Combined) -->
        <header class="main-header h-16 flex justify-between items-center px-6 border-b border-gray-200 shrink-0">
            <!-- Left Side: Bot Info -->
            <div>
                 <p class="text-xs text-gray-500 mb-1">You are currently talking to...</p>
                 <div class="flex items-center space-x-4">
                     <span id="current-bot-name" class="font-bold text-lg text-gray-800">Marketing Comms Strategist</span>
                     
                             <!-- Mode Switch (only for select bots) -->
        <div id="mode-switch" class="hidden flex items-center space-x-1 bg-gray-100 rounded-lg p-1">
            <button id="mode-strategic" class="mode-button px-3 py-1 text-xs font-medium rounded-md transition-colors bg-white text-gray-900 shadow-sm" title="For plans, messaging frameworks, PR briefs, risk/mitigation">
                Strategic
            </button>
            <button id="mode-balanced" class="mode-button px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900" title="For everyday ideation with some novelty">
                Balanced
            </button>
            <button id="mode-creative" class="mode-button px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900" title="For slogans, hooks, headlines, campaign concepts">
                Creative
            </button>
            <div class="relative">
                <button id="mode-help-button" class="w-5 h-5 rounded-full border border-gray-400 hover:border-gray-500 flex items-center justify-center text-xs font-light text-gray-400 hover:text-gray-500 transition-colors" title="Mode explanations">
                    ?
                </button>
                <div id="mode-help-tooltip" class="absolute top-6 right-0 bg-gray-800 text-white text-xs rounded-lg p-3 w-64 shadow-lg z-50 hidden">
                    <div class="space-y-1">
                        <div><span class="font-semibold">Strategic:</span> Plans, frameworks, PR briefs</div>
                        <div><span class="font-semibold">Balanced:</span> Everyday ideation with novelty</div>
                        <div><span class="font-semibold">Creative:</span> Slogans, hooks, campaign concepts</div>
                    </div>
                </div>
            </div>
        </div>
                 </div>
            </div>
            <!-- Right Side: User Profile -->
            <div class="relative">
                <button id="user-menu-button" class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-black flex items-center justify-center text-white font-bold">
                        <span id="user-initial">U</span>
                    </div>
                    <span id="user-name" class="text-sm font-medium">Demo User</span>
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                    <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                        Profile
                    </a>
                    <button id="logout-button" class="w-full text-left flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Debug Panel (temporarily visible) -->
        <div id="debugPanel" class="bg-yellow-50 border-b border-yellow-200 p-2 text-xs shrink-0">
            <div class="flex justify-between items-center">
                <span class="font-semibold text-yellow-800">Debug Mode</span>
                <button onclick="toggleDebugPanel()" class="text-yellow-600 hover:text-yellow-800">Hide</button>
            </div>
            <div id="debugInfo" class="mt-1 text-yellow-700">
                <div>API: <span id="debugApiUrl">-</span></div>
                <div>Last Error: <span id="debugLastError">None</span></div>
                <div>Image URL: <span id="debugImageUrl">None</span></div>
            </div>
        </div>

        <!-- Chat Output -->
        <div id="chat-output" class="chat-output p-6 space-y-4">
             <!-- Messages will be appended here by JS -->
        </div>

        <!-- Input Area -->
        <div class="input-area py-6 bg-white">
            <div class="max-w-4xl mx-auto px-4">
            <!-- Image Attachment Preview -->
            <div id="attachment-preview-container" class="hidden mb-2">
                <div class="relative inline-block">
                    <!-- Uploading placeholder with spinner -->
                    <div id="uploading-placeholder" class="h-20 w-32 bg-gray-100 border-2 border-dashed border-gray-300 rounded-md flex items-center justify-center">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-gray-600"></div>
                    </div>
                    <!-- Actual thumbnail (hidden during upload) -->
                    <img id="attachment-thumbnail" class="h-20 w-auto rounded-md hidden" src="">
                    <button id="remove-attachment-button" class="absolute -top-2 -right-2 bg-gray-700 text-white rounded-full p-0.5 hover:bg-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>
            <div class="relative">
                <textarea id="message-input" rows="3" class="w-full py-3 pl-12 pr-12 border border-gray-300 rounded-lg resize-none focus:border-gray-500 focus:outline-none" placeholder="Ask your assistant..."></textarea>
                <button id="upload-button" class="absolute bottom-3.5 left-4 text-gray-500 hover:text-gray-800">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                </button>
                 <input type="file" id="file-input" class="hidden" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif">
                <button id="send-message-button" class="absolute bottom-3.5 right-4 text-gray-600 hover:text-black">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>
                </button>
            </div>
             <p class="text-xs text-gray-400 text-center mt-2">This AI can make mistakes. We do not use your data to train other models.</p>
            </div>
        </div>

    </main>

    <!-- Context Menu for Conversations -->
    <div id="conversation-context-menu" class="hidden absolute w-40 bg-white rounded-md shadow-lg py-1 z-20">
        <button data-action="rename" class="w-full text-left flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Rename</button>
        <button data-action="move" class="w-full text-left flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Move to folder</button>
        <div class="border-t my-1"></div>
        <button data-action="delete" class="w-full text-left flex items-center px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Delete</button>
    </div>

    <!-- Modals -->
    <div id="toast-notification" class="fixed bottom-5 right-5 p-4 rounded-md text-white shadow-lg transition-opacity duration-300 opacity-0 hidden max-w-sm z-50">
        <p id="toast-message"></p>
    </div>
    
    <div id="input-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto">
            <h3 id="input-modal-title" class="text-lg font-medium text-gray-900 mb-4">Enter Name</h3>
            <input type="text" id="input-modal-field" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-end space-x-3">
                <button id="input-modal-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">Cancel</button>
                <button id="input-modal-confirm" class="px-4 py-2 text-sm font-medium text-white bg-gray-800 hover:bg-black rounded-md">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto">
            <h3 id="confirmation-modal-title" class="text-lg font-medium text-gray-900 mb-4">Are you sure?</h3>
            <p id="confirmation-modal-message" class="text-sm text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmation-modal-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">Cancel</button>
                <button id="confirmation-modal-confirm" class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        // Configuration - always use Railway backend as per user requirement
        const API_BASE_URL = 'https://datera-ai-suite-production.up.railway.app';
        const GATEWAY_TOKEN = 'c17e4ea45486a836e15eae268ecc5043312c96f5bec19a9fc9f1452f30b361bd';
        const BLOB_READ_WRITE_TOKEN = 'vercel_blob_rw_RGIqLjcSUWQkzWiMvQkKhNKmrUA00oA70';
        
        // Vercel Blob configuration - using direct API calls

        // Debug functions
        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function updateDebugInfo(apiUrl, error = null) {
            document.getElementById('debugApiUrl').textContent = apiUrl;
            if (error) {
                document.getElementById('debugLastError').textContent = error;
            }
        }

        // Parse markdown to HTML
        function parseMarkdownLinks(text) {
            // Escape HTML first to prevent XSS
            const escaped = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            
            let html = escaped;
            
            // Convert line breaks to <br> tags
            html = html.replace(/\n/g, '<br>');
            
            // Convert markdown headers to bold text
            html = html.replace(/^### (.+)$/gm, '<h3 class="font-semibold text-base mb-2 mt-3">$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2 class="font-semibold text-lg mb-2 mt-4">$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1 class="font-semibold text-xl mb-3 mt-4">$1</h1>');
            
            // Convert bullet points (- or * at start of line)
            // Handle both main bullets and sub-bullets
            html = html.replace(/^[\s]*[-*][\s]+(.+)$/gm, (match, content, offset, string) => {
                // Count leading spaces to determine nesting level
                const leadingSpaces = match.match(/^[\s]*/)[0].length;
                const indentLevel = Math.floor(leadingSpaces / 2); // Every 2 spaces = 1 indent level
                
                if (indentLevel > 0) {
                    // This is a sub-bullet
                    return `<li class="ml-6">${content}</li>`;
                } else {
                    // This is a main bullet
                    return `<li>${content}</li>`;
                }
            });
            
            // Wrap consecutive <li> elements in <ul>
            html = html.replace(/(<li[^>]*>.*<\/li>)(?:\s*<br>\s*<li[^>]*>.*<\/li>)*/g, (match) => {
                const listItems = match.match(/<li[^>]*>.*?<\/li>/g) || [];
                return `<ul class="list-disc ml-4 space-y-1">${listItems.join('')}</ul>`;
            });
            
            // Convert bold text **text** to <strong>
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');
            
            // Convert italic text *text* to <em>
            html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em class="italic">$1</em>');
            
            // Convert markdown links [text](url) to HTML links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">$1</a>');
            
            // Convert double line breaks to paragraph breaks
            html = html.replace(/(<br>\s*){2,}/g, '</p><p class="mb-2">');
            
            // Wrap in paragraph tags if not already wrapped
            if (!html.startsWith('<p') && !html.startsWith('<ul') && !html.startsWith('<li') && !html.startsWith('<h')) {
                html = `<p class="mb-2">${html}</p>`;
            }
            
            return html;
        }
        
        // --- Global State ---
        let currentConversationId = 'conv1';
        let currentBotId = 'general';
        let currentMode = 'strategic'; // strategic, balanced, creative
        let bots = [];
        
        // Mode temperature mapping
        const modeTemperatures = {
            'strategic': 0.3,
            'balanced': 0.5,
            'creative': 0.8
        };
        let conversations = [];
        let messages = {};
        let folders = [];
        let stagedImage = null; // Current image being uploaded
        let conversationImages = []; // All images in current conversation
        let isStreaming = false;
        let lastResponseId = null; // Store response_id for conversation state

        // --- Passcode Authentication ---
        function checkAuth() {
            const savedAuth = sessionStorage.getItem('ai-suite-auth');
            console.log('checkAuth - savedAuth:', savedAuth, 'returning:', savedAuth === 'authenticated');
            return savedAuth === 'authenticated';
        }
        
        function showLoginForm() {
            // Hide the entire app (sidebar and main content)
            const sidebar = document.querySelector('aside');
            const mainContent = document.querySelector('main');
            if (sidebar) {
                sidebar.style.display = 'none';
            }
            if (mainContent) {
                mainContent.style.display = 'none';
            }
            
            // Create and show login form
            const loginHTML = `
                <div id="login-container" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
                    <div class="max-w-md w-full space-y-8 px-4">
                        <div>
                            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                                AI Assistants Suite
                            </h2>
                            <p class="mt-2 text-center text-sm text-gray-600">
                                Enter passcode to access
                            </p>
                        </div>
                        <form class="mt-8 space-y-6" onsubmit="handleLogin(event)">
                            <div>
                                <label for="passcode-input" class="sr-only">Passcode</label>
                                <input 
                                    id="passcode-input" 
                                    name="passcode" 
                                    type="password" 
                                    required 
                                    class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" 
                                    placeholder="Enter passcode"
                                >
                            </div>
                            <div>
                                <button 
                                    type="submit" 
                                    class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-black focus:outline-none focus:ring-2 focus:ring-offset-2"
                                    style="background-color: #00FFC7;"
                                    onmouseover="this.style.backgroundColor='#00E6B3'"
                                    onmouseout="this.style.backgroundColor='#00FFC7'"
                                >
                                    Login
                                </button>
                            </div>
                            <div id="login-error" class="hidden text-red-600 text-sm text-center">
                                Invalid passcode. Please try again.
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loginHTML);
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const passcode = document.getElementById('passcode-input').value;
            const errorDiv = document.getElementById('login-error');
            
            // Simple passcode check (for testing)
            if (passcode === 'datera2024') {
                sessionStorage.setItem('ai-suite-auth', 'authenticated');
                document.getElementById('login-container').remove();
                
                // Show the entire app back (sidebar and main content)
                const sidebar = document.querySelector('aside');
                const mainContent = document.querySelector('main');
                if (sidebar) {
                    sidebar.style.display = 'block';
                }
                if (mainContent) {
                    mainContent.style.display = 'block';
                }
                
                // Re-initialize the app properly
                loadConversations();
                await loadBotConfig();
                initializeAppData();
                updateDebugInfo(API_BASE_URL);
            } else {
                errorDiv.classList.remove('hidden');
                document.getElementById('passcode-input').value = '';
            }
        }

        // --- Data Persistence ---
        function saveConversations() {
            try {
                localStorage.setItem('ai-suite-conversations', JSON.stringify(conversations));
                localStorage.setItem('ai-suite-messages', JSON.stringify(messages));
                localStorage.setItem('ai-suite-current-conversation', currentConversationId);
                localStorage.setItem('ai-suite-current-bot', currentBotId);
            } catch (e) {
                console.error('Failed to save conversations:', e);
            }
        }

        function loadConversations() {
            try {
                const savedConversations = localStorage.getItem('ai-suite-conversations');
                const savedMessages = localStorage.getItem('ai-suite-messages');
                const savedCurrentConv = localStorage.getItem('ai-suite-current-conversation');
                const savedCurrentBot = localStorage.getItem('ai-suite-current-bot');

                if (savedConversations) {
                    conversations = JSON.parse(savedConversations).map(conv => ({
                        ...conv,
                        lastActivity: new Date(conv.lastActivity)
                    }));
                } else {
                    // Initialize with default conversation
                    conversations = [
                        { id: 'conv1', title: 'New Conversation', botId: 'general', folderId: null, lastActivity: new Date() }
                    ];
                }

                if (savedMessages) {
                    messages = JSON.parse(savedMessages);
                } else {
                    messages = { 'conv1': [] };
                }

                // Always sort conversations by lastActivity for display (most recent first)
                conversations.sort((a, b) => b.lastActivity - a.lastActivity);
                
                if (savedCurrentConv && conversations.find(c => c.id === savedCurrentConv)) {
                    currentConversationId = savedCurrentConv;
                    console.log('Restored saved conversation:', currentConversationId);
                } else if (conversations.length > 0) {
                    // If no saved conversation or saved conversation doesn't exist, use the most recent
                    currentConversationId = conversations[0].id;
                    console.log('Using most recent conversation:', currentConversationId);
                }
                console.log('Conversations after sorting:', conversations.map(c => ({ id: c.id, title: c.title, lastActivity: c.lastActivity })));
                console.log('Current conversation ID:', currentConversationId);

                if (savedCurrentBot) {
                    currentBotId = savedCurrentBot;
                } else if (conversations.length > 0) {
                    // If no saved bot, use the bot from the first conversation
                    currentBotId = conversations[0].botId;
                }
                
                // Load saved mode
                const savedMode = localStorage.getItem('ai-suite-current-mode');
                if (savedMode && ['strategic', 'balanced', 'creative'].includes(savedMode)) {
                    currentMode = savedMode;
                }
            } catch (e) {
                console.error('Failed to load conversations:', e);
                // Fallback to defaults
                conversations = [
                    { id: 'conv1', title: 'New Conversation', botId: 'general', folderId: null, lastActivity: new Date() }
                ];
                messages = { 'conv1': [] };
            }
        }

        // --- UI Elements ---
        const botList = document.getElementById('bot-list');
        const conversationList = document.getElementById('conversation-list');
        const chatOutput = document.getElementById('chat-output');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message-button');
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenu = document.getElementById('user-menu');
        const logoutButton = document.getElementById('logout-button');
        const currentBotNameDisplay = document.getElementById('current-bot-name');
        const modeSwitch = document.getElementById('mode-switch');
        const modeStrategic = document.getElementById('mode-strategic');
        const modeBalanced = document.getElementById('mode-balanced');
        const modeCreative = document.getElementById('mode-creative');
        const modeHelpButton = document.getElementById('mode-help-button');
        const modeHelpTooltip = document.getElementById('mode-help-tooltip');
        const convContextMenu = document.getElementById('conversation-context-menu');
        const newFolderButton = document.getElementById('new-folder-button');
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('file-input');
        const attachmentPreviewContainer = document.getElementById('attachment-preview-container');
        const attachmentThumbnail = document.getElementById('attachment-thumbnail');
        const removeAttachmentButton = document.getElementById('remove-attachment-button');

        // --- Message Conversion ---
        function convertMessagesForAPI(frontendMessages) {
            return frontendMessages.map(msg => {
                if (msg.sender === 'user') {
                    return { role: 'user', content: msg.text };
                } else if (msg.sender === 'bot') {
                    return { role: 'assistant', content: msg.text };
                }
                return null;
            }).filter(msg => msg !== null);
        }

        // Force layout fix function
        function forceLayoutFix() {
            const mainContent = document.querySelector('.main-content');
            const chatOutput = document.querySelector('.chat-output');
            const inputArea = document.querySelector('.input-area');
            
            if (mainContent && chatOutput && inputArea) {
                // Force reflow
                mainContent.style.display = 'none';
                mainContent.offsetHeight;
                mainContent.style.display = 'flex';
                
                // Ensure proper positioning
                mainContent.style.height = '100vh';
                mainContent.style.flexDirection = 'column';
                
                chatOutput.style.flex = '1';
                chatOutput.style.minHeight = '0';
                chatOutput.style.overflowY = 'auto';
                
                inputArea.style.flexShrink = '0';
                inputArea.style.position = 'sticky';
                inputArea.style.bottom = '0';
                inputArea.style.background = 'white';
                inputArea.style.zIndex = '10';
                
                console.log('Layout fix applied');
            }
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, starting initialization...');
            
            // Check for authentication first
            if (!checkAuth()) {
                console.log('Not authenticated, showing login form');
                showLoginForm();
                return;
            }

            console.log('Authenticated, loading app...');
            
            // Load saved conversations first
            loadConversations();
            
            await loadBotConfig();
            initializeAppData();
            
            // Initialize debug panel
            updateDebugInfo(API_BASE_URL);
            
            // Force layout fix - run multiple times to ensure it sticks
            forceLayoutFix();
            setTimeout(forceLayoutFix, 100);
            setTimeout(forceLayoutFix, 500);
            setTimeout(forceLayoutFix, 1000);
            
            console.log('App initialization complete');
        });
        
        // Backup layout fix on window load
        window.addEventListener('load', () => {
            console.log('Window loaded, applying backup layout fix');
            forceLayoutFix();
        });
        
        async function loadBotConfig() {
            try {
                const response = await fetch('/bots.config.json');
                bots = await response.json();
                console.log('Loaded bots:', bots);
            } catch (error) {
                console.error('Failed to load bot config:', error);
                // Fallback configuration
                bots = [
                    { id: 'general', name: 'General', description: 'General-purpose assistant', enabled: true }
                ];
                console.log('Using fallback bots:', bots);
            }
        }
        
        function initializeAppData() {
            renderBots();
            initializeModeSwitch();
            
            // Ensure we have a valid conversation ID before loading
            if (currentConversationId && conversations.find(c => c.id === currentConversationId)) {
                loadConversation(currentConversationId);
            } else if (conversations.length > 0) {
                // Fallback to first conversation if current one is invalid
                currentConversationId = conversations[0].id;
                loadConversation(currentConversationId);
            }
        }
        
        // --- UI Rendering & Event Listeners ---
        function renderBots() {
            console.log('Rendering bots:', bots);
            botList.innerHTML = '';
            bots.forEach(bot => {
                const pill = document.createElement('button');
                const isEnabled = bot.enabled;
                const isCurrent = currentBotId === bot.id;
                
                pill.className = `w-full text-left flex items-center p-2 rounded-md font-medium text-sm bot-pill transition-colors duration-200 ${
                    isEnabled ? 'bot-hover-bg' : 'bot-disabled'
                } ${isCurrent ? 'bot-active' : ''}`;
                
                pill.dataset.botId = bot.id;
                pill.setAttribute('aria-disabled', !isEnabled);
                if (!isEnabled) {
                    pill.setAttribute('tabindex', '-1');
                }
                
                pill.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-gray-600"><path d="M12 6V2H8m0 16l-4 4V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-4.4M16.5 10.5c.83 0 1.5.7 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.7-1.5-1.5.67-1.5 1.5-1.5Zm-8 0c.83 0 1.5.7 1.5 1.5s-.67 1.5-1.5 1.5S7 12.8 7 12s.67-1.5 1.5-1.5Z"/></svg>
                    <span>${bot.name}</span>
                    ${!isEnabled ? '<span class="coming-soon-badge">Coming soon</span>' : ''}
                    <span class="ml-auto new-chat-icon opacity-0 transition-opacity">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-black"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.37 3.63a2.12 2.12 0 0 1 3 3L12 16l-4 1 1-4Z"/></svg>
                    </span>
                `;
                
                if (isEnabled) {
                    pill.addEventListener('click', () => selectBot(bot.id));
                } else {
                    pill.addEventListener('click', () => showToast('This bot is not available yet', 'error'));
                }
                
                botList.appendChild(pill);
            });
        }
        
        function selectBot(botId) {
            const bot = bots.find(b => b.id === botId);
            if (!bot || !bot.enabled) return;
            startNewConversation(botId);
        }

        function renderConversationList() {
            // Don't sort here - conversations are already sorted in loadConversations()
            conversationList.innerHTML = '';
            const unfiledConversations = conversations.filter(c => !c.folderId);

            if (unfiledConversations.length === 0) {
                 conversationList.innerHTML = '<li class="p-2 text-xs text-gray-500">No conversations.</li>';
                 return;
            }

            unfiledConversations.forEach(conv => {
                const li = document.createElement('li');
                const isSelected = conv.id === currentConversationId;
                console.log(`Rendering conversation ${conv.id} (${conv.title}), selected: ${isSelected}, currentConversationId: ${currentConversationId}`);
                li.className = `flex items-center justify-between p-2 rounded-md text-sm cursor-pointer conversation-item conversation-hover-bg prevent-select ${isSelected ? 'bg-gray-200 font-semibold' : ''}`;
                li.dataset.id = conv.id;

                const titleSpan = document.createElement('span');
                titleSpan.textContent = conv.title || `Conversation`;
                titleSpan.className = 'truncate';

                const menuBtn = document.createElement('button');
                menuBtn.className = 'conversation-menu-btn opacity-0 text-gray-500 hover:text-gray-800 p-1';
                menuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1" /><circle cx="19" cy="12" r="1" /><circle cx="5" cy="12" r="1" /></svg>`;
                
                li.addEventListener('click', () => loadConversation(conv.id));
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConversationMenu(e.currentTarget, conv.id);
                });

                li.appendChild(titleSpan);
                li.appendChild(menuBtn);
                conversationList.appendChild(li);
            });
        }
        
        function loadConversation(convId) {
            // If no conversation ID provided, don't proceed
            if (!convId) {
                console.warn('loadConversation called with no conversation ID');
                return;
            }
            
            // Always load the conversation content, even if it's the current one
            // This fixes the issue where refresh doesn't load the selected conversation
            const conv = conversations.find(c => c.id === convId);
            if (!conv) {
                console.warn('Conversation not found:', convId);
                return;
            }
            
            // Store previous conversation ID before changing it
            const previousConversationId = currentConversationId;
            currentConversationId = convId;
            currentBotId = conv.botId;
            
            // Update UI elements
            const bot = bots.find(b => b.id === currentBotId);
            currentBotNameDisplay.textContent = bot ? bot.name : 'Unknown Bot';
            updateModeSwitch();
            
            // Always render messages for the conversation
            renderMessages();
            
            // Update conversation list highlighting
            renderConversationList();
            
            // Save the current conversation selection to localStorage
            saveConversations();
            
            // Reset response_id when switching conversations
            lastResponseId = null;
            
            // Clear staged image and conversation images when switching to a different conversation
            // (but only if it's a different conversation than the previous one)
            if (previousConversationId && previousConversationId !== convId) {
                clearStagedImage();
                conversationImages = [];
                console.log('Cleared conversation images for new conversation');
            }
        }
        
        function startNewConversation(botId) {
            const newConvId = `conv${Date.now()}`;
            const newConv = {
                id: newConvId,
                title: 'New Conversation',
                botId: botId,
                lastActivity: new Date(),
                folderId: null
            };
            // Add new conversation to the beginning of the list (most recent first)
            conversations.unshift(newConv);
            messages[newConvId] = [];
            saveConversations();
            
            // Clear staged image and conversation images when starting a new conversation
            clearStagedImage();
            conversationImages = [];
            console.log('Cleared conversation images for new conversation');
            
            loadConversation(newConvId);
        }

        function renderMessages() {
            chatOutput.innerHTML = '';
            const currentMessages = messages[currentConversationId] || [];
            if (currentMessages.length === 0) {
                const botName = bots.find(b => b.id === currentBotId)?.name || 'the assistant';
                chatOutput.innerHTML = `<div class="text-center text-gray-500 text-sm">You are starting a new conversation with ${botName}. Ask something!</div>`;
            } else {
                 currentMessages.forEach(msg => appendMessage(msg));
            }
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        function isFirstImageMessage(msg) {
            if (!msg.imageUrl) return false;
            
            const currentMessages = messages[currentConversationId] || [];
            const currentIndex = currentMessages.findIndex(m => m === msg);
            
            // Check if this is the first message with an image in this conversation
            for (let i = 0; i < currentIndex; i++) {
                if (currentMessages[i].imageUrl) {
                    return false; // Found an earlier message with an image
                }
            }
            
            return true; // This is the first message with an image
        }

        function appendMessage(msg) {
             const sender = msg.sender;
             const text = msg.text;
             const imageUrl = msg.imageUrl;

             if (sender === 'user') {
                // User messages in bubbles (right-aligned, constrained width like ChatGPT)
                const wrapper = document.createElement('div');
                wrapper.className = 'flex mb-4 justify-end max-w-4xl mx-auto px-4';
                
                const bubble = document.createElement('div');
                bubble.className = 'max-w-xl p-3 rounded-lg chat-bubble-user';
                
                // Only show image in user messages if this specific message has an image
                if (imageUrl) {
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.className = 'rounded-md mb-2 max-w-xs';
                    bubble.appendChild(img);
                }
                
                if (text) {
                    const textP = document.createElement('p');
                    textP.innerHTML = parseMarkdownLinks(text);
                    bubble.appendChild(textP);
                }
                
                wrapper.appendChild(bubble);
                chatOutput.appendChild(wrapper);
             } else {
                // Bot messages flow freely (no bubble, constrained width like ChatGPT)
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-6 w-full max-w-4xl mx-auto px-4';
                
                // Bot messages never show images (they're only in user messages)
                
                if (text) {
                    const textDiv = document.createElement('div');
                    textDiv.className = 'prose prose-sm max-w-none text-gray-800 leading-relaxed';
                    textDiv.innerHTML = parseMarkdownLinks(text);
                    wrapper.appendChild(textDiv);
                }
                
                chatOutput.appendChild(wrapper);
             }
             
             chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        // --- Mode Switching Functions ---
        function updateModeSwitch() {
            // Show mode switch only for select bots (currently just general/marketing strategist)
            const botsWithModeSwitch = ['general'];
            console.log('Updating mode switch for bot:', currentBotId, 'Should show:', botsWithModeSwitch.includes(currentBotId));
            if (botsWithModeSwitch.includes(currentBotId)) {
                modeSwitch.classList.remove('hidden');
            } else {
                modeSwitch.classList.add('hidden');
            }
        }

        function setMode(mode) {
            currentMode = mode;
            
            // Save mode to localStorage
            localStorage.setItem('ai-suite-current-mode', mode);
            
            // Update button styles
            const buttons = [modeStrategic, modeBalanced, modeCreative];
            const modes = ['strategic', 'balanced', 'creative'];
            
            buttons.forEach((button, index) => {
                if (modes[index] === mode) {
                    button.className = 'mode-button px-3 py-1 text-xs font-medium rounded-md transition-colors bg-white text-gray-900 shadow-sm';
                } else {
                    button.className = 'mode-button px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900';
                }
            });
            
            console.log(`Mode switched to: ${mode} (temperature: ${modeTemperatures[mode]})`);
        }

        function initializeModeSwitch() {
            // Set up event listeners
            modeStrategic.addEventListener('click', () => setMode('strategic'));
            modeBalanced.addEventListener('click', () => setMode('balanced'));
            modeCreative.addEventListener('click', () => setMode('creative'));
            
            // Help button functionality
            modeHelpButton.addEventListener('click', (e) => {
                e.stopPropagation();
                modeHelpTooltip.classList.toggle('hidden');
            });
            
            // Hide tooltip when clicking outside
            document.addEventListener('click', (e) => {
                if (!modeHelpButton.contains(e.target) && !modeHelpTooltip.contains(e.target)) {
                    modeHelpTooltip.classList.add('hidden');
                }
            });
            
            // Initialize with current mode (loaded from localStorage or default 'strategic')
            setMode(currentMode);
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            console.log('sendMessage called - text:', text, 'stagedImage:', stagedImage);
            if ((!text && !stagedImage) || !currentConversationId || isStreaming) return;

            const userMessage = {
                sender: 'user',
                text: text,
            };
            
            // Only add image to this specific message if there's a staged image
            if (stagedImage) {
                userMessage.imageUrl = stagedImage;
                console.log('Added imageUrl to userMessage:', stagedImage);
            }

            if (!messages[currentConversationId]) {
                messages[currentConversationId] = [];
            }
            messages[currentConversationId].push(userMessage);
            appendMessage(userMessage);
            saveConversations();

            const conv = conversations.find(c => c.id === currentConversationId);
            if (conv) {
                conv.lastActivity = new Date();
                if(conv.title === 'New Conversation' && text) {
                    conv.title = text.substring(0, 40) + (text.length > 40 ? '...' : '');
                }
                // Re-sort conversations by lastActivity (most recent first)
                conversations.sort((a, b) => b.lastActivity - a.lastActivity);
                saveConversations();
            }
            
            loadConversation(currentConversationId);
            messageInput.value = '';
            adjustTextareaHeight();
            
            // Show typing indicator
            showTypingIndicator();
            
            // Hide the thumbnail immediately when user sends message
            if (stagedImage) {
                attachmentPreviewContainer.classList.add('hidden');
            }
            
            // Send to API with all conversation images
            console.log('About to call sendToAPI with conversationImages:', conversationImages);
            await sendToAPI(text, conversationImages);
            
            // Don't clear staged image - keep it for follow-up questions in this conversation
            // Only clear when starting a new conversation
        }

        function showTypingIndicator() {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex mb-4 justify-start';
            wrapper.id = 'typing-indicator';
            
            const bubble = document.createElement('div');
            bubble.className = 'max-w-xl p-3 rounded-lg chat-bubble-bot';
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            
            bubble.appendChild(typingDiv);
            wrapper.appendChild(bubble);
            chatOutput.appendChild(wrapper);
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function sendToAPI(text, imageUrls = []) {
            console.log('sendToAPI called with:', { text, imageUrls });
            isStreaming = true;
            sendMessageButton.disabled = true;
            
            // Map bot IDs to persona IDs
            const botToPersonaMap = {
                'general': 'mktg_strategist'  // General GPT-5 uses marketing strategist persona
            };
            
            const personaId = botToPersonaMap[currentBotId] || currentBotId;
            
            try {
                const requestBody = {
                    messages: convertMessagesForAPI(messages[currentConversationId] || []),
                    bot_id: personaId,
                    model: 'gpt-5',
                    verbosity: 'medium',
                    reasoning_effort: 'medium',
                    temperature: modeTemperatures[currentMode],
                    previous_response_id: lastResponseId
                };
                
                // Add image URLs if present (send all conversation images)
                if (imageUrls && imageUrls.length > 0) {
                    requestBody.image_urls = imageUrls; // Send as array
                }
                
                console.log('Sending request body:', requestBody);
                
                const response = await fetch(`${API_BASE_URL}/v1/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GATEWAY_TOKEN}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botResponse = '';

                console.log('Frontend: Received response from backend, starting to read stream...');

                // Remove typing indicator
                removeTypingIndicator();

                // Create bot message container (flowing style, no bubble, constrained width like ChatGPT)
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-6 w-full max-w-4xl mx-auto px-4';
                wrapper.id = 'bot-response';
                
                const textDiv = document.createElement('div');
                textDiv.className = 'prose prose-sm max-w-none text-gray-800 leading-relaxed';
                wrapper.appendChild(textDiv);
                chatOutput.appendChild(wrapper);

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                console.log('Frontend: Received streaming data:', data);
                                if (data.content) {
                                    botResponse += data.content;
                                    console.log('Frontend: Current botResponse so far:', botResponse);
                                    const parsedHTML = parseMarkdownLinks(botResponse);
                                    console.log('Frontend: Parsed HTML:', parsedHTML);
                                    textDiv.innerHTML = parsedHTML;
                                    chatOutput.scrollTop = chatOutput.scrollHeight;
                                }
                                if (data.metadata && data.metadata.response_id) {
                                    // Store response_id for conversation state
                                    lastResponseId = data.metadata.response_id;
                                    console.log('Stored response_id:', lastResponseId);
                                }
                                if (data.done) {
                                    // Add to messages
                                    if (!messages[currentConversationId]) {
                                        messages[currentConversationId] = [];
                                    }
                                    messages[currentConversationId].push({
                                        sender: 'bot',
                                        text: botResponse
                                    });
                                    saveConversations();
                                    break;
                                }
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                            } catch (e) {
                                console.error('Error parsing chunk:', e);
                                // Update debug info
                                updateDebugInfo(API_BASE_URL, e.message);
                                
                                // Show error in UI
                                removeTypingIndicator();
                                showToast(`Error: ${e.message}`, 'error');
                                
                                // Add error message to chat
                                if (!messages[currentConversationId]) {
                                    messages[currentConversationId] = [];
                                }
                                messages[currentConversationId].push({
                                    sender: 'bot',
                                    text: `Error: ${e.message}`
                                });
                                saveConversations();
                                renderMessages();
                                break;
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('API Error:', error);
                // Update debug info
                updateDebugInfo(API_BASE_URL, error.message);
                
                removeTypingIndicator();
                showToast(`API Error: ${error.message}`, 'error');
                
                // Add error message
                if (!messages[currentConversationId]) {
                    messages[currentConversationId] = [];
                }
                messages[currentConversationId].push({
                    sender: 'bot',
                    text: `API Error: ${error.message}`
                });
                saveConversations();
                renderMessages();
            } finally {
                isStreaming = false;
                sendMessageButton.disabled = false;
            }
        }

        // --- Event Listeners & UI Helpers ---
        messageInput.addEventListener('input', adjustTextareaHeight);
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            const maxHeight = 200;
            if (messageInput.scrollHeight > maxHeight) {
                messageInput.style.height = maxHeight + 'px';
                messageInput.style.overflowY = 'auto';
            } else {
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
                messageInput.style.overflowY = 'hidden';
            }
        }
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        sendMessageButton.addEventListener('click', sendMessage);

        userMenuButton.addEventListener('click', () => userMenu.classList.toggle('hidden'));
        logoutButton.addEventListener('click', () => {
            // Clear session storage and refresh to go back to login screen
            sessionStorage.removeItem('ai-suite-auth');
            window.location.reload();
        });
        
        document.addEventListener('click', (e) => {
            if (!userMenuButton.contains(e.target) && !userMenu.contains(e.target)) {
                userMenu.classList.add('hidden');
            }
            if (!convContextMenu.contains(e.target) && !e.target.closest('.conversation-menu-btn')) {
                convContextMenu.classList.add('hidden');
            }
        });
        
        let contextMenuConvId = null;
        function showConversationMenu(target, convId) {
             contextMenuConvId = convId;
             const rect = target.getBoundingClientRect();
             convContextMenu.style.top = `${rect.bottom}px`;
             convContextMenu.style.left = `${rect.left - convContextMenu.offsetWidth}px`;
             convContextMenu.classList.remove('hidden');
        }

        convContextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            convContextMenu.classList.add('hidden');
            if (action === 'rename') {
                renameConversation(contextMenuConvId);
            } else if (action === 'delete') {
                const conv = conversations.find(c => c.id === contextMenuConvId);
                const title = conv ? conv.title : 'this conversation';
                showConfirmationModal(`Are you sure you want to delete "${title}"?`, () => {
                    deleteConversation(contextMenuConvId);
                });
            }
        });

        function deleteConversation(convId) {
            conversations = conversations.filter(c => c.id !== convId);
            delete messages[convId];
            
            if (currentConversationId === convId) {
                currentConversationId = null;
                if (conversations.length > 0) {
                    conversations.sort((a,b) => b.lastActivity - a.lastActivity);
                    loadConversation(conversations[0].id)
                } else {
                    chatOutput.innerHTML = '<div class="text-center text-gray-500 text-sm">No conversations. Start a new one!</div>';
                    currentBotNameDisplay.textContent = "";
                }
            }
            saveConversations();
            renderConversationList();
        }
        
        function showInputModal(title, callback, currentValue = '') {
            const modal = document.getElementById('input-modal');
            const titleEl = document.getElementById('input-modal-title');
            const inputEl = document.getElementById('input-modal-field');
            const confirmBtn = document.getElementById('input-modal-confirm');
            const cancelBtn = document.getElementById('input-modal-cancel');
            
            titleEl.textContent = title;
            inputEl.value = currentValue;
            modal.classList.remove('hidden');
            inputEl.focus();
            inputEl.select();

            const confirmHandler = () => {
                if(inputEl.value.trim()){
                    callback(inputEl.value.trim());
                    cleanup();
                }
            }
            
            const cleanup = () => {
                 modal.classList.add('hidden');
                 confirmBtn.removeEventListener('click', confirmHandler);
                 cancelBtn.removeEventListener('click', cleanup);
                 inputEl.removeEventListener('keydown', keydownHandler);
            }
            
            const keydownHandler = (e) => {
                if (e.key === 'Enter') confirmHandler();
                if (e.key === 'Escape') cleanup();
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cleanup);
            inputEl.addEventListener('keydown', keydownHandler);
        }
        
        function showConfirmationModal(message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const messageEl = document.getElementById('confirmation-modal-message');
            const confirmBtn = document.getElementById('confirmation-modal-confirm');
            const cancelBtn = document.getElementById('confirmation-modal-cancel');

            messageEl.textContent = message;
            modal.classList.remove('hidden');

            const confirmHandler = () => {
                onConfirm();
                cleanup();
            };

            const cleanup = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cleanup);
            };
            
            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cleanup);
        }

        function renameConversation(convId) {
             const conv = conversations.find(c => c.id === convId);
             if (!conv) return;
             const currentTitle = conv.title === 'New Conversation' ? '' : conv.title;
             showInputModal("Rename Conversation", (newName) => {
                conv.title = newName;
                saveConversations();
                loadConversation(convId);
             }, currentTitle);
        }
        

        // --- Attachment Logic ---
        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                // Validate file type more strictly
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    showToast('Please select a valid image file (JPEG, PNG, WEBP, or GIF).', 'error');
                    return;
                }
                
                // Validate file size (50MB limit)
                if (file.size > 50 * 1024 * 1024) {
                    showToast('File too large. Maximum size is 50MB.', 'error');
                    return;
                }
                
                try {
                    // Show uploading placeholder with spinner
                    attachmentPreviewContainer.classList.remove('hidden');
                    document.getElementById('uploading-placeholder').classList.remove('hidden');
                    document.getElementById('attachment-thumbnail').classList.add('hidden');
                    
                    // Reset placeholder content to spinner
                    const placeholder = document.getElementById('uploading-placeholder');
                    placeholder.innerHTML = '<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-gray-600"></div>';
                    
                    // Upload via Vercel serverless function
                    const response = await fetch('/api/upload-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/octet-stream',
                            'x-filename': file.name
                        },
                        body: file
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Upload failed: ${errorData.error || response.statusText}`);
                    }
                    
                    const blob = await response.json();
                    
                    // Store the image URL for later use
                    stagedImage = blob.url;
                    console.log('Image upload successful, stagedImage set to:', stagedImage);
                    console.log('stagedImage variable after assignment:', stagedImage);
                    
                    // Add to conversation images array
                    conversationImages.push(blob.url);
                    console.log('Added to conversationImages:', conversationImages);
                    
                    // Update debug panel with all image URLs
                    document.getElementById('debugImageUrl').textContent = conversationImages.join(', ');
                    
                    // Switch from spinner to thumbnail
                    document.getElementById('uploading-placeholder').classList.add('hidden');
                    attachmentThumbnail.src = blob.url;
                    document.getElementById('attachment-thumbnail').classList.remove('hidden');
                    
                    // Clear file input to allow re-uploading same file
                    fileInput.value = '';
                    
                } catch (error) {
                    console.error('Error uploading image:', error);
                    
                    // Show upload failed message in placeholder
                    const placeholder = document.getElementById('uploading-placeholder');
                    placeholder.innerHTML = '<div class="text-red-600 text-xs text-center leading-tight">Upload<br>failed</div>';
                    
                    // Keep placeholder visible but remove the spinner
                    // Don't hide the container, just change the content
                }
            } else {
                showToast('Please select a valid image file (JPEG, PNG, WEBP, or GIF).', 'error');
            }
        });

        removeAttachmentButton.addEventListener('click', clearStagedImage);
        
        function clearStagedImage() {
            stagedImage = null;
            attachmentPreviewContainer.classList.add('hidden');
            attachmentThumbnail.src = '';
            fileInput.value = '';
            
            // Clear debug image URL
            document.getElementById('debugImageUrl').textContent = 'None';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;

            toast.className = 'fixed bottom-5 right-5 p-4 rounded-md text-white shadow-lg transition-opacity duration-300 z-50';
            if (type === 'success') {
                toast.classList.add('bg-green-500');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.add('bg-black');
            }
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }

    </script>
</body>
</html>

